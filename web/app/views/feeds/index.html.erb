<%#= render partial: "feeds/float_menu" unless mobile_device? %>

<section data-controller="page" data-target="page.page" class="me-page me-page--feed is-animated">

	<%# if current_user && current_user.notifications_topics_all_requested == false %>
	<!-- <div class="me-section">
      <div class="me-section__inner">
        <div class="me-notification" data-controller="notification" data-notification-active="<%= current_user&.notifications_topics_all_active %>">
          <div class="me-switch mdc-switch" data-target="notification.switch">
            <div class="mdc-switch__track"></div>
            <div class="mdc-switch__thumb-underlay">
              <div class="mdc-switch__thumb">
                <input data-target="notification.input" data-action="change->notification#change" type="checkbox" <%= 'checked' if current_user&.notifications_topics_all_active %> id="another-basic-switch" class="mdc-switch__native-control" role="switch">
              </div>
            </div>
          </div>
          <label for="another-basic-switch" data-target="notification.label">Notificações
            <span>Receba até 1 notificação por dia para avisar sobre seus eventos agendados e novos eventos que podem te interessar.</span>
          </label>
        </div>
      </div>
    </div> -->
	<%# end %>

	<% cache([current_user, 'swipable-events']) do %>
		<% if current_user && @swipable_items.size > 0 && (current_user&.swipable.dig('events', 'last_view_at').blank? || current_user&.swipable.dig('events', 'last_view_at').try { |last_view_at| last_view_at < (DateTime.now - 8.hours) }) %>
			<div class="me-section <%= 'me-section--without-padding' if current_user&.swipable.dig('events', 'last_view_at').blank? %>">
				<div class="me-section__inner">
					<%= render partial: 'components/swipable/swipable' %>
				</div>
			</div>
		<% end %>
	<% end %>

	<% if current_user && @new_events_today.size > 0 %>
		<div class="me-section me-section--condensed">
			<div class="me-section__inner">
				<div class="me-info">
					<div class="me-info__content">
						<% if @new_events_today.size == 1 %>
							<%= link_to "Foi adicionado um evento nas últimas 24 horas!", recent_events_path(current_user) %>
						<% else %>
							<%= link_to "Foram adicionados #{@new_events_today.size} eventos nas últimas 24 horas!", recent_events_path(current_user) %>
						<% end %>
					</div>
				</div>
			</div>
		</div>
	<% end %>

	<% cache([current_user, 'events_saved', @saved_events.map(&:id), @saved_events.maximum(:updated_at)]) do %>
		<% if current_user %>
			<section class="me-section me-section--condensed">
				<div class="me-section__inner">
					<%= render partial: 'saves',
										 locals:  {
												 identifier:      'events_saved',
												 saved_resources: @saved_events,
												 empty_message:   "Salve eventos com ❤ para vê - los aqui"
										 } %>
				</div>
			</section>
		<% end %>
	<% end %>

	<%= render partial: "components/collection/events/collection", layout: "components/section", locals: {
			collection: @collection_week
	} %>

	<%= render partial: "components/collection/events/collection", layout: "components/section", locals: {
			collection: @collection_suggestions
	} %>

	<% custom_title = capture do %>
		<% if current_user %>
			<div class="me-chip-set__wrapper">
				<div class="me-chip-set mdc-chip-set">
					<% current_user&.following_topics.filter { |topic| topic.events.active.size > 0 }.sort_by { |topic| topic.events.active.size }.reverse!.each do |topic| %>
						<a onclick="window.AnimateModule.animatePageHide()" href="<%= link_to_topic topic %>" class="me-chip mdc-chip <%= 'new' if topic.events.active.any? { |event| current_user&.last_sign_in_at < event.created_at } %>">
							<div class="mdc-chip__ripple"></div>
							<%= topic.details_name.titleize %>
							<% if topic.events.active.size > 0 %>
								<i class="me-chip__counter"><%= topic.events.active.size %></i>
							<% end %>
						</a>
					<% end %>
				</div>
			</div>
		<% end %>
	<% end %>
	<%= render partial: "components/collection/events/collection",
						 layout:  "components/section",
						 locals:  {
								 collection: @collection_follow.deep_merge!(
										 custom_title: custom_title
								 )
						 } %>

	<% custom_title = capture do %>
		<% if current_user %>
			<div class="me-user-suggestions">
				<div class="me-user-suggestions__inner">
					<% User.following_users(current_user).each do |user| %>
						<%= link_to user_path user do %>
							<div onclick="window.AnimateModule.animatePageHide()" class="me-user-suggestions__user">
								<div class="me-user-suggestions__picture" style="background-image: url('<%= user.picture %>')">
								</div>
								<div class="me-user-suggestions__name">
									<%= user.first_name %>
								</div>
							</div>
						<% end %>
					<% end %>
				</div>
			</div>
		<% end %>
	<% end %>
	<%= render partial: "components/collection/events/collection",
						 layout:  "components/section",
						 locals:  {
								 collection: @collection_following_users.deep_merge!(
										 custom_title: custom_title
								 )
						 } %>

	<% custom_title = capture do %>
		<% if current_user %>
			<div class="me-chip-set__wrapper">
				<div class="me-chip-set mdc-chip-set mdc-chip-set--choice">
					<% ['Cidade Baixa', 'Centro Histórico', 'Bom Fim', 'Moinhos de Vento'].each do |neighborhood| %>
						<%= link_to neighborhood_events_path(neighborhood.parameterize), onclick: "window.AnimateModule.animatePageHide()", class: "me-chip mdc-chip #{'mdc-chip--selected' if neighborhood == 'Cidade Baixa'}" do %>
							<div class="mdc-chip__ripple"></div>
							<%= neighborhood.titleize %>
						<% end %>
					<% end %>
				</div>
			</div>
		<% end %>
	<% end %>
	<%= render partial: "components/collection/events/collection",
						 layout:  "components/section",
						 locals:  {
								 collection: @collection_neighborhood.deep_merge!(
										 custom_title: custom_title
								 )
						 } %>



	<% if mobile_device? %>
		<div data-controller="button" data-target="button.button" class="me-button mdc-button mdc-button--raised" onclick="location.assign('/porto-alegre/eventos')" style="max-width: 80vw; margin: 36px auto; text-align: center; display: block">
			<div class="mdc-button__ripple"></div>
			<span class="mdc-button__label">Explorar todos os eventos</span>
		</div>
	<% end %>

</section>
