var converter=new showdown.Converter;converter.setOption("openLinksInNewWindow",!0);const environment={development:location.hostname+":3030",production:location.host+"/bot/"};var Botkit={config:{ws_url:("https:"===location.protocol?"wss":"ws")+"://"+environment.development,reconnect_timeout:3e3,max_reconnect:5},options:{sound:!1,use_sockets:!0},reconnect_count:0,guid:null,current_user:null,on:function(e,t){this.message_window.addEventListener(e,function(e){t(e.detail)})},trigger:function(e,t){e=new CustomEvent(e,{detail:t});this.message_window.dispatchEvent(e)},request:function(e,t){return new Promise(function(n,o){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(i.readyState==XMLHttpRequest.DONE)if(200==i.status){var e=i.responseText,t=null;try{t=JSON.parse(e)}catch(s){return void o(s)}n(t)}else o(new Error("status_"+i.status))},i.open("POST",e,!0),i.setRequestHeader("Content-Type","application/json"),i.send(JSON.stringify(t))})},send:function(e,t){var n=this;if(t&&t.preventDefault(),e){var o={type:"outgoing",text:e};return this.clearReplies(),n.renderMessage(o),n.deliverMessage({type:"message",text:e,user:this.guid,channel:this.options.use_sockets?"socket":"webhook"}),this.input.value="",this.trigger("sent",o),!1}},deliverMessage:function(e){this.options.use_sockets?this.socket.send(JSON.stringify(e)):this.webhook(e)},getHistory:function(){var e=this;e.guid&&e.request("/bot/botkit/history",{user:e.guid}).then(function(t){t.success?e.trigger("history_loaded",t.history):e.trigger("history_error",new Error(t.error))})["catch"](function(t){e.trigger("history_error",t)})},webhook:function(e){var t=this;t.request("/bot/botkit/receive",e).then(function(e){t.trigger(e.type,e)})["catch"](function(e){t.trigger("webhook_error",e)})},connect:function(e){var t=this;e&&e.id&&(Botkit.setCookie("botkit_guid",e.id,1),e.timezone_offset=(new Date).getTimezoneOffset(),t.current_user=e,console.log("CONNECT WITH USER",e)),t.options.use_sockets?t.connectWebsocket(t.config.ws_url):t.connectWebhook()},connectWebhook:function(){var e=this;Botkit.getCookie("botkit_guid")?(e.guid=Botkit.getCookie("botkit_guid"),connectEvent="welcome_back"):(e.guid=e.generate_guid(),Botkit.setCookie("botkit_guid",e.guid,1)),e.getHistory(),e.trigger("connected",{}),e.webhook({type:connectEvent,user:e.guid,channel:"webhook"})},connectWebsocket:function(e){var t=this;t.socket=new WebSocket(e);var n="hello";Botkit.getCookie("botkit_guid")?(t.guid=Botkit.getCookie("botkit_guid"),n="welcome_back"):(t.guid=t.generate_guid(),Botkit.setCookie("botkit_guid",t.guid,1)),t.getHistory(),t.socket.addEventListener("open",function(e){console.log("CONNECTED TO SOCKET"),t.reconnect_count=0,t.trigger("connected",e),t.deliverMessage({type:n,user:t.guid,channel:"socket",user_profile:t.current_user?t.current_user:null})}),t.socket.addEventListener("error",function(e){console.error("ERROR",e)}),t.socket.addEventListener("close",function(e){console.log("SOCKET CLOSED!"),t.trigger("disconnected",e),t.reconnect_count<t.config.max_reconnect?setTimeout(function(){console.log("RECONNECTING ATTEMPT ",++t.reconnect_count),t.connectWebsocket(t.config.ws_url)},t.config.reconnect_timeout):t.message_window.className="offline"}),t.socket.addEventListener("message",function(e){var n=null;try{n=JSON.parse(e.data)}catch(o){return void t.trigger("socket_error",o)}t.trigger(n.type,n)})},clearReplies:function(){this.replies.innerHTML=""},quickReply:function(e){this.send(e)},focus:function(){this.input.focus()},renderMessage:function(e){var t=this;t.next_line||(t.next_line=document.createElement("div"),t.message_list.appendChild(t.next_line)),e.text&&(e.html=converter.makeHtml(e.text)),t.next_line.innerHTML=t.message_template({message:e}),e.isTyping||delete t.next_line},triggerScript:function(e,t){this.deliverMessage({type:"trigger",user:this.guid,channel:"socket",script:e,thread:t})},identifyUser:function(e){e.timezone_offset=(new Date).getTimezoneOffset(),this.guid=e.id,Botkit.setCookie("botkit_guid",e.id,1),this.current_user=e,this.deliverMessage({type:"identify",user:this.guid,channel:"socket",user_profile:e})},receiveCommand:function(e){switch(e.data.name){case"trigger":console.log("TRIGGER",e.data.script,e.data.thread),Botkit.triggerScript(e.data.script,e.data.thread);break;case"identify":console.log("IDENTIFY",e.data.user),Botkit.identifyUser(e.data.user);break;case"connect":Botkit.connect(e.data.user);break;default:console.log("UNKNOWN COMMAND",e.data)}},sendEvent:function(e){this.parent_window&&this.parent_window.postMessage(e,"*")},setCookie:function(e,t,n){var o=new Date;o.setTime(o.getTime()+24*n*60*60*1e3);var i="expires="+o.toUTCString();document.cookie=e+"="+t+";"+i+";path=/"},getCookie:function(e){for(var t=e+"=",n=decodeURIComponent(document.cookie).split(";"),o=0;o<n.length;o++){for(var i=n[o];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""},generate_guid:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},boot:function(e){console.log("Booting up");var t=this;t.message_window=document.getElementById("message_window"),t.message_list=document.getElementById("message_list");var n=document.getElementById("message_template").innerHTML;return t.message_template=Handlebars.compile(n),t.replies=document.getElementById("message_replies"),t.input=document.getElementById("messenger_input"),t.focus(),t.on("connected",function(){t.message_window.className="connected",t.input.disabled=!1,t.sendEvent({name:"connected"})}),t.on("disconnected",function(){t.message_window.className="disconnected",t.input.disabled=!0}),t.on("webhook_error",function(e){alert("Error sending message!"),console.error("Webhook Error",e)}),t.on("typing",function(){t.clearReplies(),t.renderMessage({isTyping:!0})}),t.on("sent",function(){t.options.sound&&new Audio("sent.mp3").play()}),t.on("message",function(){t.options.sound&&new Audio("beep.mp3").play()}),t.on("event",function(e){"reload"==e.name&&t.sendEvent({type:"event",name:e.name,params:e.params})}),t.on("message",function(e){t.renderMessage(e)}),t.on("message",function(e){e.goto_link&&(window.location=e.goto_link)}),t.on("message",function(e){if(t.clearReplies(),e.quick_replies){for(var n=document.createElement("ul"),o=[],i=0;i<e.quick_replies.length;i++)!function(e){var i=document.createElement("li"),s=document.createElement("a");s.innerHTML=e.title,s.href="#",s.onclick=function(){t.quickReply(e.payload)},i.appendChild(s),n.appendChild(i),o.push(i)}(e.quick_replies[i]);t.replies.appendChild(n),e.disable_input?t.input.disabled=!0:t.input.disabled=!1}else t.input.disabled=!1}),t.on("history_loaded",function(e){if(e)for(var n=0;n<e.length;n++)t.renderMessage({text:e[n].text,type:"message_received"==e[n].type?"outgoing":"incoming"})}),window.self!==window.top?(t.parent_window=window.parent,window.addEventListener("message",t.receiveCommand,!1),t.sendEvent({type:"event",name:"booted"}),console.log("Messenger booted in embedded mode")):(console.log("Messenger booted in stand-alone mode"),t.connect(e)),t}};Botkit.boot();